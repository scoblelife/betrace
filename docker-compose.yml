# BeTrace Development Docker Compose
#
# This file is for local development. For production deployments, use:
#   distribution/docker/docker-compose.yml
#
# Quick Start:
#   docker compose up -d
#
# Access Points:
#   - Grafana:  http://localhost:12015 (admin/admin)
#   - Backend:  http://localhost:12011
#   - gRPC:     localhost:12012
#   - Tempo:    http://localhost:3200

version: '3.8'

services:
  # BeTrace Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: betrace-backend
    ports:
      - "${BETRACE_PORT_BACKEND:-12011}:12011"
      - "${BETRACE_PORT_GRPC:-12012}:12012"
    volumes:
      - betrace-data:/app/data
    environment:
      - BETRACE_PORT_GRPC=12012
      - BETRACE_PORT_BACKEND=12011
      - BETRACE_DATA_DIR=/app/data
      - BETRACE_SIGNATURE_KEY=${BETRACE_SIGNATURE_KEY:-change-in-production}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:12011/v1/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - betrace

  # Grafana with BeTrace Plugin
  grafana:
    image: grafana/grafana:latest
    container_name: betrace-grafana
    ports:
      - "${BETRACE_PORT_GRAFANA:-12015}:3000"
    volumes:
      - ./grafana-betrace-app/dist:/var/lib/grafana/plugins/betrace
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=betrace-app
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - betrace

  # BeTrace BFF (Frontend)
  bff:
    build:
      context: ./bff
      dockerfile: Dockerfile
    container_name: betrace-bff
    ports:
      - "${BETRACE_PORT_BFF:-12013}:3000"
    environment:
      - VITE_BETRACE_API_URL=http://backend:12011
      - VITE_DEMO_MODE=true
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - betrace

  # Tempo (trace storage)
  tempo:
    image: grafana/tempo:latest
    container_name: betrace-tempo
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./config/tempo.yaml:/etc/tempo.yaml
      - tempo-data:/tmp/tempo
    ports:
      - "3200:3200"   # Tempo HTTP
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - betrace

volumes:
  betrace-data:
    driver: local
  grafana-data:
    driver: local
  tempo-data:
    driver: local

networks:
  betrace:
    driver: bridge
